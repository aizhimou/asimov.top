---
title: "FFmpeg ç¼–ç å’Œç¼–è¾‘å…¥é—¨"
subtitle: ""
summary: "ä¸€ç¯‡æ–‡ç« ææ‡‚ FFmpeg çš„åŸºæœ¬åŸç†ã€å…¥é—¨è·¯çº¿åŠå¸¸ç”¨æ“ä½œã€‚"
date: 2021-06-12T21:23:46+08:00
tags: ['FFmpeg']
categories: ['Media']
featuredImage: https://ahmadawais.com/wp-content/uploads/2021/05/FFmpeg.jpg
featuredImagePreview: https://ahmadawais.com/wp-content/uploads/2021/05/FFmpeg.jpg
draft: false
---

æœ¬æ–‡ä¸»è¦å†…å®¹ç¿»è¯‘è‡ªä¸€ç¯‡ä»‹ç» FFmpeg å…¥é—¨çŸ¥è¯†çš„è‹±æ–‡ Web å¹»ç¯ç‰‡ï¼ŒåŠ å…¥äº†ä¸€äº›ä¸ªäººç†è§£ä¸å­¦ä¹ æ³¨é‡Šã€‚

æˆ‘ç¿»è¯‘è¿™ç¯‡æ–‡ç« çš„ç›®çš„ï¼Œä¸€æ˜¯å­¦ä¹  FFmpeg ç›¸å…³çš„çŸ¥è¯†ï¼ŒäºŒæ˜¯ç»ƒä¹ è‹±æ–‡ç¿»è¯‘èƒ½åŠ›ã€‚ä½†æ˜¯å—é™äºä¸ªäººæ°´å¹³ï¼Œæœ‰äº›è‹±æ–‡ä¸“ä¸šåè¯ç¿»è¯‘æˆä¸­æ–‡æœ‰äº›æ€ªå¼‚ï¼Œç¢°åˆ°è§‰å¾—ç¿»è¯‘ä¸å¥½çš„åœ°æ–¹ï¼Œæ–‡ä¸­ä¼šé™„ä¸ŠåŸæ–‡è¯è¯­ï¼Œå»ºè®®ç»“åˆåŸæ–‡æ›´å¥½ç†è§£ã€‚

åŸæ–‡ä½œè€…æ˜¯ä¸€åè§†é¢‘è´¨é‡ä¸ä½“éªŒè´¨é‡ç ”ç©¶å‘˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ UniversitÃ¤t Ilmenau çš„ä¸€ååšå£«ç”Ÿå’ŒåŠ©ç†ç ”ç©¶å‘˜ã€‚åŸæ–‡å†™å¾—éå¸¸æ£’ï¼Œæ–‡æœ¬è´¨é‡å’Œæ’ç‰ˆéƒ½æ¯”æˆ‘çš„è¯‘æ–‡æ›´å¥½ï¼Œå»ºè®®æœ‰è‹±æ–‡åŸºç¡€çš„æœ‹å‹ç›´æ¥é˜…è¯»åŸæ–‡ï¼Œé“¾æ¥ï¼š[FFMPEG ENCODING AND EDITING COURSE](https://slhck.info/ffmpeg-encoding-course)

## è¯¾ç¨‹ç›®æ ‡
- åŸºæœ¬æ¦‚å¿µ
- å®‰è£… ffmpeg å’Œç›¸å…³å·¥å…·
- ç¼–ç è§†é¢‘
- ä½¿ç”¨è¿‡æ»¤å™¨ï¼ˆæ»¤é•œï¼‰
- åˆ†æè§†é¢‘

## å‰ç½®è¦æ±‚
- è¿™ä»½å¹»ç¯ç‰‡ï¼ˆåŸæ–‡æ˜¯ web å¹»ç¯ç‰‡çš„å½¢å¼ï¼‰
- å·²å®‰è£… ffmpegã€ffprobeã€ffplay
- ä¸€äº›æ ·ä¾‹è§†é¢‘ï¼Œæ¯”å¦‚ï¼š[Big Buck Bunny](http://distribution.bbb3d.renderfarming.net/video/mp4/bbb_sunflower_1080p_60fps_normal.mp4)

## èµ„æº
å¦‚æœä½ éœ€è¦ä¸€äº›æ ·ä¾‹è§†é¢‘ç”¨åšæµ‹è¯•ï¼Œå¯ä»¥å‚è€ƒ VQEG (Video Quality Experts Group) çš„è¯´æ˜ï¼šhttps://www.its.bldrdoc.gov/vqeg/video-datasets-and-organizations.aspx

# FFMPEG ç®€ä»‹

## å…³äº

- ç”¨äºå¤šåª’ä½“ç¼–è¾‘ã€è½¬æ¢... çš„å…è´¹å¼€æºè½¯ä»¶
- å¼€å§‹äº 2000 å¹´
- æŒç»­ç»´æŠ¤å’Œå¼€å‘è‡³ä»Š

ç±»ä¼¼æˆ–ç›¸å…³ï¼ˆä¸”æœ‰ç”¨ï¼‰çš„æ¡†æ¶ï¼š

- [ImageMagick](https://www.imagemagick.org/)
- [MLT Framework](https://www.mltframework.org/)

## å·¥å…·
FFmpeg æ˜¯ä¸€ç³»åˆ—è½¯ä»¶åŒ…å’Œç±»åº“çš„ç»„åˆï¼ŒåŒ…æ‹¬ï¼š

- å‘½ä»¤è¡Œå·¥å…·ï¼šffmpegã€ffprobeã€ffplay
- ç±»åº“ï¼šlibavformat, libavcodec, libavfilter, â€¦

å…¶ä¸­ç±»åº“è¢«è®¸å¤šé¡¹ç›®ä½¿ç”¨ï¼ˆæ¯”å¦‚ VLCã€MLT Framework ç­‰ï¼‰å¹¶ä¸”å¯ä»¥åœ¨ C/C++ ä»£ç ä¸­ä½¿ç”¨

## ç±»åº“

- libavformatï¼šè¯»å–å’Œå†™å…¥å®¹å™¨æ ¼å¼ï¼ˆAVI, MKV, MP4, â€¦ï¼‰
- libavcodecï¼šè¯»å–å’Œå†™å…¥ç¼–è§£ç å™¨ï¼ˆH.264, H.265, VP9, â€¦ï¼‰
- libavfilterï¼šå„ç§ä¸ªæ ·çš„è§†é¢‘å’ŒéŸ³é¢‘è¿‡æ»¤å™¨
- ä»¥åŠå…¶ä»–...

å…³äºå¦‚ä½•ä»¥ç¼–ç¨‹çš„æ–¹å¼ä½¿ç”¨ç±»åº“çš„æ ·ä¾‹ï¼š
[http://leixiaohua1020.github.io/#ffmpeg-development-examples](http://leixiaohua1020.github.io/#ffmpeg-development-examples)

ä»¥åŠä¸€äº›å…¶ä»–æœ‰ç”¨çš„ï¼ˆé FFmpeg çš„ï¼‰ç±»åº“ï¼š

- OpenCV: é¢å‘æ›´å¤šç±»å‹çš„ä¿¡å·å¤„ç†
- Python: MoviePy, pyav, scikit-video

## æ¶æ„

ç®€åŒ–çš„ FFmpeg æ•´ä½“æ¶æ„

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-1.png)

## å®‰è£… / ç¼–è¯‘

| å®‰è£…æ–¹å¼  | ä¼˜åŠ¿ | åŠ£åŠ¿ |
| -------------- | ---------------------------------- | ------------------ |
| ä»æºç ç¼–è¯‘ | å¯ä»¥è‡ªå®šä¹‰æ‰€æœ‰é…ç½®ï¼Œå·¥å…·ï¼Œç¼–è§£ç å™¨ | è´¹æ—¶é—´ï¼Œå‡çº§å›°éš¾   |
| ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬ | ç®€å•ä¸”å¿«é€Ÿ | ä¸æä¾›æ‰€æœ‰ç¼–è§£ç å™¨ï¼Œéœ€è¦æ‰‹åŠ¨å‡çº§ |
| åŒ…ç®¡ç†å™¨å®‰è£… | ç®€å•ä¸”å¿«é€Ÿ | å¯èƒ½ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿä¸æä¾›æ‰€æœ‰ç¼–è§£ç å™¨ |

- è·å–æºä»£ç å’Œé¢„ç¼–è¯‘ç‰ˆæœ¬ï¼šhttp://ffmpeg.org/download.html
- Windows é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼šhttps://ffmpeg.org/download.html#build-windows

## è·å–å¸®åŠ©

- å®˜æ–¹æ–‡æ¡£ï¼šhttps://ffmpeg.org/ffmpeg-all.html
- Wiki çŸ¥è¯†åº“ï¼šhttp://trac.ffmpeg.org/wiki
-  IRC èŠå¤©å®¤ï¼š#ffmpeg
-  é‚®ä»¶åˆ—è¡¨ï¼šhttps://lists.ffmpeg.org/mailman/listinfo/ffmpeg-user/
-  Stack Overflow: https://stackoverflow.com/ and use #ffmpeg
-  Super User: http://superuser.com/ and use #ffmpeg
-  â€¦ æˆ–è€…é—®æˆ‘

# åŸºç¡€è§†é¢‘ç¼–ç æ¦‚å¿µ

## å®¹å™¨æ ¼å¼ï¼ˆContainer Formatsï¼‰

å®¹å™¨åŒ…å«åª’ä½“æ•°æ®ã€‚æ¯”å¦‚ï¼š

- MP4: MPEG-4 Part 14 å®¹å™¨ï¼Œç”¨äº H.264, H.264, AAC éŸ³é¢‘, â€¦
- MKV: å¯ä»¥åŒ…å«å‡ ä¹æ‰€æœ‰åª’ä½“ç¼–ç æ ¼å¼çš„ä¸‡èƒ½å®¹å™¨
- WebM: MKV å®¹å™¨çš„å­é›†ï¼Œä¸»è¦ç”¨äºç½‘ç»œåª’ä½“æµ
- AVI: ä¼ ç»Ÿå®¹å™¨

åœ¨ FFmpeg ä¸­æŸ¥çœ‹æ”¯æŒçš„å®¹å™¨ï¼š

```bash
$ ffmpeg -formats
File formats:
 D. = Demuxing supported
 .E = Muxing supported
 --
 D  3dostr          3DO STR
  E 3g2             3GP2 (3GPP2 file format)
  E 3gp             3GP (3GPP file format)
 D  4xm             4X Technologies
  E a64             a64 - video for Commodore 64
 D  aa              Audible AA format files
 ...
```

## ç¼–è§£ç å™¨ï¼ˆCodecsï¼‰

- ç¼–è§£ç å™¨ = ç¼–ç å™¨ / è§£ç å™¨
- å¦‚ä½•ç¼–ç å’Œè§£ç è§†é¢‘ã€éŸ³é¢‘...çš„è§„èŒƒ
- é€šå¸¸ä¸æ˜¯å¦‚ä½•ç¼–ç  / å‹ç¼©æ•°æ®çš„è§„èŒƒ
- æœ‰æ—¶å€™ â€œç¼–è§£ç å™¨â€ è¢«ç”¨äºç›´æ¥æŒ‡ä»£ ç¼–ç  / è§£ç çš„è½¯ä»¶

è¯‘è€…æŒ‰ï¼šCodec å¯ä»¥ç†è§£ä¸ºç¼–ç åè®®ï¼Œä¸åŒçš„åè®®å¤„ç†æ•°æ®ï¼ˆéŸ³è§†é¢‘ï¼‰çš„è§„åˆ™ä¸ä¸€æ ·ï¼Œåè®®æœ‰å…è´¹å¼€æºçš„ï¼Œè‡ªç„¶ä¹Ÿæœ‰å•†ç”¨ç§æœ‰çš„ã€‚

æŸ¥çœ‹ FFmpeg æ”¯æŒçš„ç¼–è§£ç å™¨ï¼š

```bash
$ ffmpeg -codecs
Codecs:
 D..... = Decoding supported
 .E.... = Encoding supported
 ..V... = Video codec
 ..A... = Audio codec
 ..S... = Subtitle codec
 ...I.. = Intra frame-only codec
 ....L. = Lossy compression
 .....S = Lossless compression
 -------
 D.VI.. 012v                 Uncompressed 4:2:2 10-bit
 D.V.L. 4xm                  4X Movie
 D.VI.S 8bps                 QuickTime 8BPS video
 .EVIL. a64_multi            Multicolor charset for Commodore 64 (encoders: a64multi )
 .EVIL. a64_multi5           Multicolor charset for Commodore 64, extended with 5th color (colram) (encoders: a64multi5 )
 D.V..S aasc                 Autodesk RLE
 D.VIL. aic                  Apple Intermediate Codec
```

## æœ€é‡è¦çš„æœ‰æŸç¼–è§£ç å™¨ï¼ˆLossy Codecsï¼‰

ç›®å‰ä¸»è¦ä½¿ç”¨çš„ï¼Œç”± ITU / ISO æ ‡å‡†åŒ–ï¼š

- ğŸ¥ H.262 / MPEG-2 Part H: ä¸»è¦æ˜¯å¹¿æ’­ã€ç”µè§†ä½¿ç”¨ï¼Œç”¨äºå‘åå…¼å®¹
- ğŸ¥ H.264 / MPEG-4 Part 10: å½“ä»Šè§†é¢‘ç¼–ç å™¨çš„äº‹å®æ ‡å‡†ï¼ˆ2018å¹´ï¼‰
- ğŸ¥ H.265 / HEVC / MPEG-H: H.264 çš„ç»§ä»»è€…ï¼Œè§†é¢‘è´¨é‡æå‡ 50%
- ğŸ”Š MP3 / MPEG-2 Audio Layer III: æ›¾ç»æ˜¯éŸ³é¢‘ç¼–ç çš„äº‹å®æ ‡å‡†
- ğŸ”Š AAC / ISO/IEC 14496-3:2009: é«˜çº§éŸ³é¢‘ç¼–ç æ ‡å‡†

å…æˆæƒè´¹ï¼ˆå…ç‰ˆæƒçš„ï¼‰ä¸»è¦ç«äº‰è€…ï¼š

- ğŸ¥ VP8: ç”± Google æå‡ºçš„å¼€æºå…è´¹ç¼–è§£ç å™¨ï¼ˆå¦‚ä»Šä½¿ç”¨å¹¶ä¸å¤šï¼‰
- ğŸ¥ VP9: VP8 çš„ç»§ä»»è€…ï¼Œå‡ ä¹å’Œ H.265 ä¸€æ ·å¥½
- ğŸ¥ AV1: VP9 çš„ç»§ä»»è€…ï¼Œå£°ç§°æ¯” H.265 æ›´å¥½

## æœ€é‡è¦çš„æ— æŸç¼–è§£ç å™¨ï¼ˆLossless Codecsï¼‰

æ— æŸç¼–è§£ç å™¨åœ¨å­˜æ¡£ã€ç¼–è¾‘...é¢†åŸŸéå¸¸æœ‰ç”¨
æ— æŸç¼–ç  = åœ¨è¾ƒå°çš„æ–‡ä»¶ä½“ç§¯ä¸‹æ²¡æœ‰å‹ç¼©æŸå¤±

- ğŸ¥ Raw YUV, HuffYUV, FFV1, ffvhuff â€¦
- ğŸ”Š Raw PCM, FLAC, ALAC, â€¦

å½“ç„¶ï¼Œè¿˜æœ‰ â€œè§†è§‰æ— æŸâ€ ç¼–è§£ç å™¨ï¼š

- ğŸ¥ Apple ProRes, Avid DNxHD, JPEG2000, high-quality H.264/H.265, ...
- High bitrate and usually only I-framesï¼ˆé«˜ç ç‡å¸§å†…å‹ç¼©ï¼‰

## ç¼–ç å™¨ï¼ˆEncodersï¼‰

- ç¼–ç å™¨æ˜¯è¾“å‡ºç¼–ç åå­—èŠ‚æµçš„å®é™…è½¯ä»¶
- ç¼–ç å™¨ä¼šå½±å“è§†é¢‘çš„è´¨é‡å’Œæ€§èƒ½ï¼Œä¸€äº›ç¼–ç å™¨ä¼šå¥½äºå¦ä¸€äº›ï¼ˆæœ‰äº›å…è´¹ï¼Œæœ‰äº›ä¸å…è´¹ï¼‰

è¯‘è€…æŒ‰ï¼šEncoder å¯ä»¥ç†è§£ä¸º Codecï¼ˆç¼–ç åè®®ï¼‰çš„å…·ä½“å®ç°æ–¹å¼ï¼Œä¸åŒçš„å®ç°æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œæœ‰å…è´¹å¼€æºçš„å®ç°ï¼Œä¹Ÿæœ‰å•†ç”¨ç§æœ‰çš„å®ç°ã€‚ 

ä¾‹å¦‚ï¼š

- ğŸ¥ libx264: æœ€å—æ¬¢è¿çš„ H.264 ç¼–ç å™¨
- ğŸ¥ NVENC: NVIDIA GPU ä¸“ç”¨çš„ H.264 ç¼–ç å™¨
- ğŸ¥ libx265: å…è´¹å¼€æºçš„ HEVCï¼ˆH.265ï¼‰ç¼–ç å™¨
- ğŸ¥ libvpx: Google æ¨å‡ºçš„ VP8 å’Œ VP9 ç¼–ç å™¨
- ğŸ¥ libaom: AV1 ç¼–ç å™¨
- ğŸ”Š libfdk-aac: AAC ç¼–ç å™¨
- ğŸ”Š aac: åŸç”Ÿï¼ˆé»˜è®¤ï¼‰ FFmpeg AAC ç¼–ç å™¨
- â€¦

æ€»çš„æ¥è¯´ï¼Œç¼–ç å™¨æ–¹é¢æœ‰å¾ˆå¤šç«äº‰ã€‚

æŸ¥çœ‹ FFmpeg æ”¯æŒçš„ç¼–ç å™¨ï¼š

```bash
$ ffmpeg -encoders
Encoders:
 V..... = Video
 A..... = Audio
 S..... = Subtitle
 .F.... = Frame-level multithreading
 ..S... = Slice-level multithreading
 ...X.. = Codec is experimental
 ....B. = Supports draw_horiz_band
 .....D = Supports direct rendering method 1
 ------
 V..... a64multi             Multicolor charset for Commodore 64 (codec a64_multi)
 V..... a64multi5            Multicolor charset for Commodore 64, extended with 5th color (colram) (codec a64_multi5)
 V..... alias_pix            Alias/Wavefront PIX image
...
```

## åƒç´ æ ¼å¼ï¼ˆPixel Formatsï¼‰

- è§†é¢‘æµä¸­åŸå§‹åƒç´ çš„è¡¨ç¤º
- æŒ‡å®šäº®åº¦ / è‰²å½©å’Œé¥±å’Œåº¦çš„é‡‡æ ·é¡ºåº

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-2.png)

æŸ¥çœ‹ FFmpeg æ”¯æŒçš„åƒç´ æ ¼å¼ï¼š

```bash
âœ  ~ ffmpeg -pix_fmts --hide_banner
Pixel formats:
I.... = Supported Input  format for conversion
.O... = Supported Output format for conversion
..H.. = Hardware accelerated format
...P. = Paletted format
....B = Bitstream format
FLAGS NAME            NB_COMPONENTS BITS_PER_PIXEL BIT_DEPTHS
-----
IO... yuv420p                3             12      8-8-8
IO... yuyv422                3             16      8-8-8
IO... rgb24                  3             24      8-8-8
IO... bgr24                  3             24      8-8-8
IO... yuv422p                3             16      8-8-8
IO... yuv444p                3             24      8-8-8
IO... yuv410p                3              9      8-8-8
IO... yuv411p                3             12      8-8-8
...
```

è¯‘è€…æŒ‰ï¼šè¿™å—æˆ‘ä¹Ÿæ²¡çœ‹æ˜ç™½ï¼Œå…ˆæ”¾ç€å§ ğŸ˜‚ï¼Œæˆ‘æ¯”è¾ƒå…³å¿ƒè§†é¢‘ç¼–ç ï¼ˆæ•°æ®å‹ç¼©ï¼‰çš„éƒ¨åˆ† 

# ç”¨ FFmpeg å‘½ä»¤è¡Œå·¥å…·ç¼–ç 

## åŸºæœ¬è¯­æ³•

```bash
ffmpeg <global-options> <input-options> -i <input> <output-options> <output>
```

- å…¨å±€å‚æ•°ï¼ˆglobal-optionsï¼‰ç”¨äºæ—¥å¿—è¾“å‡ºï¼Œè¦†ç›–æ–‡ä»¶ç­‰
- è¾“å…¥å‚æ•°ï¼ˆinput-optionsï¼‰ç”¨äºè¯»å–æ–‡ä»¶
- è¾“å‡ºå‚æ•°ï¼ˆoutput-optionsï¼‰ç”¨äºï¼š
	- è½¬æ¢ï¼ˆç¼–ç æ ¼å¼ï¼Œè§†é¢‘è´¨é‡ç­‰ï¼‰
	- è¿‡æ»¤å™¨ï¼ˆfilteringï¼‰
	- æµæ˜ å°„ï¼ˆstream mappingï¼‰
	- ...

å®Œæ•´çš„å¸®åŠ© / å‚è€ƒæ–‡æ¡£ï¼š`ffmpeg -h full` æˆ–è€… `man ffmpeg` ä½†æ˜¯å†…å®¹éå¸¸éå¸¸å¤šï¼

## è½¬ç å’Œè½¬æ¢ï¼ˆTRANSCODING AND TRANSMUXINGï¼‰

ä»ä¸€ç§ç¼–ç æ ¼å¼è½¬ç åˆ°å¦ä¸€ç§ç¼–ç æ ¼å¼ï¼ˆTranscodingï¼‰ï¼Œæ¯”å¦‚ç”¨ libx264 ç¼–ç å™¨è½¬ä¸º H.264 ç¼–ç æ ¼å¼

```bash
ffmpeg -i <input> -c:v libx264 output.mp4
```

ä»ä¸€ç§è§†é¢‘å®¹å™¨è½¬æ¢ä¸ºå¦ä¸€ç§è§†é¢‘å®¹å™¨ï¼Œä¸ç”¨é‡æ–°ç¼–ç 

```bash
ffmpeg -i input.mp4 -c copy output.mkv
```

ffmpeng ä¼šä»è¾“å…¥ä¸­è·å–ä¸€ä¸ªè§†é¢‘ã€éŸ³é¢‘å’Œå­—å¹•æµå¹¶å°†å…¶æ˜ å°„åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ã€‚

æ³¨é‡Šï¼š

- -c è®¾ç½®ç¼–ç å™¨ï¼ˆå‚è€ƒ ffmpeg -encoders)
- -c å¤åˆ¶æ¯”ç‰¹æµï¼ˆcopy only copies bitstreamï¼‰
- -c:v è®¾ç½®è§†é¢‘ç¼–ç å™¨
- -c:a è®¾ç½®éŸ³é¢‘ç¼–ç å™¨
- -an å’Œ -vn åˆ†åˆ«æ˜¯ç¦ç”¨éŸ³é¢‘å’Œè§†é¢‘æµ

### è½¬ç çš„èƒŒåï¼ˆTRANSCODING BACKGROUNDï¼‰

èŠ‚é€‰è‡ª [http://ffmpeg.org/ffmpeg-all.html](http://ffmpeg.org/ffmpeg-all.html)ï¼š
> ffmpeg [â€¦] read[s] input files and get packets containing encoded data from them. When there are multiple input files, ffmpeg tries to keep them synchronized [â€¦]. 
> Encoded packets are then passed to the decoder. [â€¦] The decoder produces uncompressed frames [â€¦] which can be processed further by filtering [â€¦]. After filtering, the frames are passed to the encoder, which encodes them and outputs encoded packets. Finally those are passed to the muxer, which writes the encoded packets to the output file.

è¯‘è€…æŒ‰ï¼šè¿™æ®µä¸“ä¸šåè¯å¤ªå¤šï¼Œå°è¯•ç¿»è¯‘äº†å‡ æ¬¡éƒ½æ„Ÿè§‰å¤ªåƒµç¡¬å¤ªå¥‡æ€ªäº†ã€‚å…¶å®å°±æ˜¯å‰é¢é‚£ä¸ªæ¶æ„å›¾çš„æ–‡å­—æè¿°ã€‚

å¤§æ¦‚æ„æ€æ˜¯ï¼šffmpeg ä»æ–‡ä»¶ä¸­è¯»å–ç¼–ç è¿‡çš„æ•°æ®åŒ…ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œffmpeg ä¼šå°è¯•åŒæ­¥å¤šä¸ªæ–‡ä»¶ã€‚ç„¶åè¿™äº›ç¼–ç è¿‡çš„æ•°æ®åŒ…ï¼ˆencoded packetsï¼‰ä¼šè¢«å‘é€åˆ°è§£ç å™¨ï¼ˆdecoderï¼‰ï¼Œè§£ç å™¨å°†è¿™äº›æ•°æ®åŒ…è§£ç ä¸ºåŸå§‹è§†é¢‘å¸§ï¼ˆuncompressed framesï¼‰ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨å„ç§è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰æ¥å¤„ç†è¿™äº›è§†é¢‘å¸§ï¼ˆframesï¼‰ï¼Œç„¶åè¿™äº›å¤„ç†è¿‡åçš„è§†é¢‘å¸§ç‡ä¼šè¢«å‘é€åˆ°ç¼–ç å™¨ï¼ˆencoderï¼‰ï¼Œç¼–ç å™¨ä¼šå°†ä»–ä»¬ç¼–ç ä¸ºæ•°æ®åŒ…ï¼ˆencoded packetsï¼‰ï¼Œæœ€åè¿™äº›æ•°æ®åŒ…ä¼šè¢«å‘é€åˆ°æ··æµå™¨ï¼ˆmuxerï¼‰ï¼Œæœ€ç»ˆæ··æµå™¨å°†è¿™äº›æ•°æ®åŒ…è¾“å‡ºä¸ºæ–‡ä»¶ã€‚

## æŸ¥æ‰¾å’Œå‰ªåˆ‡ï¼ˆSEEKING AND CUTTINGï¼‰

ä» <èµ·å§‹ç‚¹ï¼ˆstartï¼‰> ç”¨ <æŒç»­æ—¶é—´ï¼ˆdurationï¼‰> æˆ–è€… <ç»“æŸç‚¹ï¼ˆendï¼‰> æ¥å‰ªåˆ‡è§†é¢‘

```bash
ffmpeg -ss <start> -i <input> -t <duration> -c copy <output>
ffmpeg -ss <start> -i <input> -to <end> -c copy <output>
```

ä¾‹å¦‚ï¼š

```bash
ffmpeg -ss 00:01:50 -i <input> -t 10.5 -c copy <output>
ffmpeg -ss 2.5 -i <input> -to 10 -c copy <output>
```

### ä½¿ç”¨ SEEKNG æ³¨æ„äº‹é¡¹

- é‡æ–°ç¼–ç è§†é¢‘æ—¶ï¼Œseeking æ€»æ˜¯å¯ä»¥ç²¾ç¡®åˆ°æ—¶é—´æˆ³
- å½“æ‹·è´è§†é¢‘æµè€Œæ²¡æœ‰ç»è¿‡é‡æ–°ç¼–ç æ—¶ï¼ˆ-c copyï¼‰ï¼Œffmpeg å¯èƒ½ä¼šåŒ…å«æœªæ˜¾ç¤ºä½†æ˜¯å¿…è¦çš„å¸§
- ä½¿ç”¨ `-c copy` å‰ªåˆ‡è§†é¢‘æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿé»‘å¸§å¼€å¤´çš„è§†é¢‘ï¼ˆåœ¨æŸäº›æ’­æ”¾å™¨ä¸Šï¼‰
- è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ï¼š
	- [http://trac.ffmpeg.org/wiki/Seeking](http://trac.ffmpeg.org/wiki/Seeking)
	- [https://superuser.com/questions/138331/using-ffmpeg-to-cut-up-video](https://superuser.com/questions/138331/using-ffmpeg-to-cut-up-video)

è¯‘è€…æŒ‰ï¼šä¹‹æ‰€ä»¥åœ¨å‰ªåˆ‡è§†é¢‘æ—¶ï¼Œè½¬ç äºä¸è½¬ç å­˜åœ¨æ—¶é—´å‡†ç¡®æ€§ä¸Šçš„å·®åˆ«ï¼Œæ˜¯å› ä¸ºè½¬ç æ—¶ï¼ŒåŸè§†é¢‘çš„æ¯ä¸€å¸§éƒ½ä¼šè¢« ffmpeg è¯»å–å‡ºæ¥ï¼ˆä¹Ÿå°±æ˜¯ decodeï¼‰ï¼Œå› æ­¤å¯ä»¥å‡†ç¡®çš„å®šä½åˆ°æ—¶é—´ç‚¹ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰è½¬ç ï¼Œç›´æ¥å¤åˆ¶è§†é¢‘æµçš„æ—¶å€™ï¼Œffmpeg å¹¶ä¸ä¼šé€å¸§åˆ†æè§†é¢‘ï¼Œè€Œæ˜¯é‡‡ç”¨â€œå…³é”®å¸§â€æ¥å®šä½æ—¶é—´ï¼Œå½“è®¾å®šçš„æ—¶é—´ç‚¹ä¸Šæ²¡æœ‰å…³é”®å¸§æ—¶ï¼Œå°±ä¼šå‡ºç°ä¸€äº›æ—¶é—´åå·®ã€‚

## è®¾ç½®è´¨é‡

- è¾“å‡ºæ–‡ä»¶çš„è´¨é‡å–å†³äºç¼–ç å™¨é»˜è®¤è®¾ç½®äºåŸææ–™ï¼ˆä¹Ÿå°±æ˜¯åŸè§†é¢‘ï¼‰çš„è´¨é‡
- ä¸è¦åœ¨æœªè®¾ç½®ä»»ä½•è´¨é‡æ°´å¹³çš„æƒ…å†µä¸‹è¿›è¡Œç¼–ç 
- é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ éœ€è¦é€‰æ‹©ä¸€ä¸ªç›®æ ‡æ¯”ç‰¹ç‡æˆ–è€…è´¨é‡æ°´å¹³
- ç›®æ ‡æ¯”ç‰¹ç‡å–å†³äºè§†é¢‘çš„ç±»å‹ï¼Œå¤§å°å’Œå¸§ç‡

### è®¾ç½®è´¨é‡çš„å‚æ•°

å¯èƒ½ä¼šä½¿ç”¨åˆ°çš„å‚æ•°ï¼ˆä»…ç¤ºä¾‹ï¼‰

- -b:v æˆ–è€… -b:a è®¾ç½®æ¯”ç‰¹ç‡
	- æ¯”å¦‚ï¼š-b:v 1000K = 1000kbit/s, -b:v 8M = 8Mbit/s
- q:v æˆ–è€… -q:a è®¾ç½®å›ºå®šè´¨é‡å‚æ•°
	- æ¯”å¦‚ï¼š-q:a 2 è®¾ç½®ä¸ºåŸç”Ÿ AAC ç¼–ç å™¨

ä¸€äº›ç¼–ç æ–¹å¼çš„ç¤ºä¾‹ï¼š

- -crf ç”¨æ¥è®¾ç½® libx264/libx265 çš„ æ’å®šç ç‡å› å­ï¼ˆ[Constant Rate Factor](http://slhck.info/video/2017/02/24/crf-guide.html)ï¼‰
- vbr ä¸º FDK-AAC ç¼–ç å™¨è®¾ç½®å›ºå®šè´¨é‡
- è¿˜æœ‰å¾ˆå¤šå…¶ä»–å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ `ffmpeg -h encoder=libx264 for examples` æŸ¥çœ‹ï¼Œå¦‚ä¸‹

```bash
âœ  ~ ffmpeg -h encoder=libx264 for examples -hide_banner
Encoder libx264 [libx264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10]:
    General capabilities: dr1 delay threads 
    Threading capabilities: other
    Supported pixel formats: yuv420p yuvj420p yuv422p yuvj422p yuv444p yuvj444p nv12 nv16 nv21 yuv420p10le yuv422p10le yuv444p10le nv20le gray gray10le
libx264 AVOptions:
  -preset            <string>     E..V....... Set the encoding preset (cf. x264 --fullhelp) (default "medium")
  -tune              <string>     E..V....... Tune the encoding params (cf. x264 --fullhelp)
  -profile           <string>     E..V....... Set profile restrictions (cf. x264 --fullhelp) 
  -fastfirstpass     <boolean>    E..V....... Use fast settings when encoding first pass (default true)
  -level             <string>     E..V....... Specify level (as defined by Annex A)
  -passlogfile       <string>     E..V....... Filename for 2 pass stats
  -wpredp            <string>     E..V....... Weighted prediction for P-frames
  -a53cc             <boolean>    E..V....... Use A53 Closed Captions (if available) (default true)
  -x264opts          <string>     E..V....... x264 options
  -crf               <float>      E..V....... Select the quality for constant quality mode (from -1 to FLT_MAX) (default -1)
  -crf_max           <float>      E..V....... In CRF mode, prevents VBV from lowering quality beyond this point. (from -1 to FLT_MAX) (default -1)
  -qp                <int>        E..V....... Constant quantization parameter rate control method (from -1 to INT_MAX) (default -1)
  -aq-mode           <int>        E..V....... AQ method (from -1 to INT_MAX) (default -1)
...
```

### ä»€ä¹ˆæ˜¯ CRFï¼Ÿ

- CRF = [Constant Rate Factor](http://slhck.info/video/2017/02/24/crf-guide.html)
- åœ¨æ•´ä¸ªç¼–ç è¿‡ç¨‹ä¸­ï¼Œä¿æŒæ’å®šçš„è´¨é‡
- åœ¨ä¸å¤ªæ³¨é‡æ–‡ä»¶å¤§å°çš„æƒ…å†µä¸‹ï¼Œé€‚åˆä»¥å›ºå®šçš„è´¨é‡å­˜å‚¨è§†é¢‘

### ç¤ºä¾‹ï¼šè½¬ç ä¸º H.264ï¼ŒPart 1

ä»¥å›ºå®šè´¨é‡ï¼ˆCRFï¼‰ç¼–ç ï¼š

```bash
ffmpeg -i <input> -c:v libx264 -crf 23 -c:a aac -b:a 128k output.mkv
```

é’ˆå¯¹ H.264 ç¼–ç ï¼ŒCRF åœ¨ 18 åˆ° 28 ä¹‹é—´çœ‹èµ·æ¥â€œæ¯”è¾ƒå¥½â€ï¼ŒCRF å€¼è¶Šä½è§†é¢‘è´¨é‡è¶Šå¥½ã€‚ï¼ˆ HEVC å’Œ VP9 ç¼–ç çš„ CRF å€¼ä¸åŒï¼‰

### ç¤ºä¾‹ï¼šè½¬ç ä¸º H.264ï¼ŒPart 2

åŒé‡ç¼–ç ï¼ˆTwo-passï¼‰æ¨¡å¼ï¼š

```bash
ffmpeg -y -i <input> -c:v libx264 -b:v 8M -pass 1 -c:a aac -b:a 128k -f mp4 /dev/null
ffmpeg -i <input> -c:v libx264 -b:v 8M -pass 2 -c:a aac -b:a 128k output.mp4
```

Windows ç”¨æˆ·ï¼šç”¨ `nul` ä»£æ›¿ `/dev/null`

æ›´å¤šç»†èŠ‚ï¼Œå‚è€ƒï¼š[https://trac.ffmpeg.org/wiki/Encode/H.264](https://trac.ffmpeg.org/wiki/Encode/H.264)

## ç ç‡æ§åˆ¶

ä¸åŒçš„æ§åˆ¶æ–¹å¼ï¼š

- å›ºå®šç ç‡ï¼ˆConstant Bitrateï¼šCBRï¼‰
- åŠ¨æ€ç ç‡ï¼ˆVariable Bitrateï¼šVBRï¼‰
	- å¹³å‡ç ç‡ï¼ˆAverage Bitrateï¼šABRï¼‰
	- æ’å®šè´¨é‡å‚æ•°ï¼ˆConstant quantization parameterï¼šCQPï¼‰
	- åŸºäºå¿ƒé‡Œè§†è§‰ç‰¹å¾çš„æ’å®šè´¨é‡ï¼Œæ¯”å¦‚ x264/x265/libvpx-vp9 ç¼–ç å™¨ä¸­ä½¿ç”¨ CRFï¼ˆConstant quality, based on psychovisual propertiesï¼‰
	- é™åˆ¶å‹ç ç‡ï¼ˆConstrained Bitrateï¼šVBVï¼‰

å…·ä½“åœ¨å“ªç§æƒ…å†µä¸‹ä½¿ç”¨å“ªç§ç ç‡æ¨¡å¼ï¼Œå‚è€ƒï¼š[https://slhck.info/video/2017/03/01/rate-control.html](https://slhck.info/video/2017/03/01/rate-control.html)

**é‡è¦è¯´æ˜ï¼šåˆé€‚çš„ç ç‡å–å†³äºå†…å®¹ç‰¹å¾ï¼**

è¯‘è€…æŒ‰ï¼šå¯¹è§†é¢‘æ¥è¯´ï¼Œç ç‡å¹¶éè¶Šé«˜è¶Šå¥½ï¼Œä¸åŒå†…å®¹ç‰¹å¾çš„è§†é¢‘å¯¹ç ç‡çš„è¦æ±‚å¹¶ä¸ä¸€æ ·ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š[ä»€ä¹ˆå†³å®šäº†ä½ çœ‹åˆ°çš„ç”»è´¨](https://sspai.com/post/66001)

### ç ç‡æ§åˆ¶ç¤ºä¾‹

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-3.png)

- ä¸åŒç ç‡æ§åˆ¶æ¨¡å¼ä¸‹ï¼Œå¸§å¤§å°éšæ—¶é—´å˜åŒ–å›¾ï¼ˆå·²å¹³æ»‘åŒ–å¤„ç†ï¼‰
- æ³¨æ„ ABR æ¨¡å¼ä¸‹ï¼Œåœ¨ä¸€å¼€å§‹å¯¹ç ç‡çš„é”™è¯¯ä¼°è®¡

### é€Ÿåº¦ VS è´¨é‡ VS æ–‡ä»¶å¤§å°ï¼ˆSPEED VS. QUALITY VS. FILE SIZEï¼‰

æœ‰æŸç¼–ç æ¨¡å¼æ€»æ˜¯åœ¨è¿™ä¸‰è€…ä¹‹é—´é€‰æ‹©

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-4.png)

ä¾‹å¦‚ï¼š

- ä½ å¯ä»¥è®©è§†é¢‘è´¨é‡åˆå¥½ï¼Œç¼–ç åˆå¿«ï¼Œä½†æ˜¯è¾“å‡ºæ–‡ä»¶ä¼šå¾ˆå¤§
- ä½ å¯ä»¥è®©è§†é¢‘è´¨é‡åˆå¥½ï¼Œæ–‡ä»¶åˆå°ï¼Œä½†æ˜¯ç¼–ç é€Ÿåº¦ä¼šå¾ˆæ…¢
- ä½ å¯ä»¥è®©æ–‡ä»¶åˆå°ï¼Œç¼–ç åˆå¿«ï¼Œä½†æ˜¯è§†é¢‘è´¨é‡å°±ä¼šæ¯”è¾ƒå·®

ç¼–è€…æŒ‰ï¼šå‡¡äº‹éœ€è¦åšæŠ‰æ‹©çš„åœ°æ–¹ï¼Œä¸å¯èƒ½ä¸‰è§’æ€»åœ¨é‚£å„¿ç­‰ç€ä½ ã€‚è§†é¢‘ç¼–ç æ—¶å¦‚ä½•å¹³è¡¡é€Ÿåº¦ã€è´¨é‡å’Œæ–‡ä»¶å¤§å°ï¼Œæ˜¯æœ€é‡è¦ä¹Ÿæ˜¯æœ€å¤æ‚çš„è¯¾é¢˜ä¹‹ä¸€ï¼Œåé¢ä¼šå­¦ä¹ /æ’°å†™/ç¿»è¯‘æ›´å¤šçš„æ–‡ç« æ¥ä»‹ç»ã€‚

### X264 ç¼–ç å™¨ä¸­çš„é€Ÿåº¦/è´¨é‡é¢„è®¾

ä½¿ç”¨é¢„è®¾æ¥é€‰æ‹© libx264 çš„ç¼–ç é€Ÿåº¦

```bash
ffmpeg -i <input> -c:v libx264 -crf 23 -preset ultrafast -an output.mkv
ffmpeg -i <input> -c:v libx264 -crf 23 -preset medium -an output.mkv
ffmpeg -i <input> -c:v libx264 -crf 23 -preset veryslow -an output.mkv
```

æ‰€æœ‰é¢„è®¾ï¼šultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow

åŒç­‰è´¨é‡ä¸‹ï¼Œä¸€äº›ç¼–ç é€Ÿåº¦äºæ–‡ä»¶ä½“ç§¯çš„å¯¹æ¯”æ ·ä¾‹ï¼š

| Preset   | Encoding Time | File Size |
| -------- | ------------- | --------- |
| ultrafast | 4.85s | 15M  |
| medium | 24.13s | 5.2M  |
| veryslow | 112.23s | 4.9M  | 	
		
## æ”¹å˜å¸§ç‡

ç®€å•çš„é€šè¿‡ä¸¢å¼ƒå¸§å’Œå¤åˆ¶å¸§çš„æ–¹å¼æ¥æ”¹å˜å¸§ç‡ï¼š

```bash
ffmpeg -i <input> -r 24 <output>
```

æ›´å¤æ‚çš„æ–¹æ³•æ¶‰åŠåˆ°è¿‡æ»¤å™¨ï¼ˆfilterï¼‰å‚è€ƒ fps, mpdecimate, minterpolate filters:

```bash
ffmpeg -i <input> -filter:v fps=24 <output>
```

## è½¨é“æ˜ å°„ï¼ˆSTREAM MAPPINGï¼‰

æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œä» 0 å¼€å§‹

ä¾‹å¦‚ï¼š

- `0:0` æ˜¯ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬ä¸€æ¡è½¨é“ï¼ˆSteamï¼‰
- `0:1` æ˜¯ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬äºŒæ¡è½¨é“
- `2:a:0` æ˜¯ç¬¬ä¸‰ä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬ä¸€æ¡éŸ³è½¨
- ...

ä½ å¯ä»¥å°†è¾“å…¥æ–‡ä»¶çš„è½¨é“æ˜ å°„åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ï¼ˆmap input streams to outputï¼‰ä¾‹å¦‚ï¼šå°†éŸ³é¢‘æ·»åŠ åˆ°è§†é¢‘ä¸­ï¼š

```bash
ffmpeg -i input.mp4 -i input.m4a -c copy -map 0:v:0 -map 1:a:0 output.mp4
```

æ›´å¤šç»†èŠ‚è¯·å‚è€ƒï¼š[http://trac.ffmpeg.org/wiki/Map](http://trac.ffmpeg.org/wiki/Map)

## ç®€å•è¿‡æ»¤å™¨ï¼ˆSIMPLE FILTERINGï¼‰

FFmpeg æœ‰å¾ˆå¤šè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•çš„è¿‡æ»¤å™¨ï¼ˆfilterï¼‰ï¼š

```bash
ffmpeg -i <input> -filter:v "<filter1>,<filter2>,<filter3>" <output>
```

ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆæ»¤é•œï¼‰æœ‰ä¸€ä¸ªåç§°ï¼Œä¸€äº›å¯é€‰é¡¹ï¼Œä»¥åŠä¸€äº›é¢„è®¾å‚æ•°ï¼š

```bash
-filter:v <name>=<option1>=<value1>:<option2>=<value2>
```

### ç¼©æ”¾ï¼ˆSCALINGï¼‰

ç¼©æ”¾åˆ° 320 x 240

```bash
ffmpeg -i <input> -vf "scale=w=320:h=240" <output>
```

ç¼©æ”¾åˆ°é«˜åº¦ 240 ä¸”ä¿æŒçºµæ¨ªæ¯”å¯è¢« 2 æ•´é™¤

```bash
ffmpeg -i <input> -vf scale=w=-2:h=240 <output>
```

ç¼©æ”¾åˆ° 1280 x 720ï¼Œå¦‚æœéœ€è¦çš„è¯ç¼©æ”¾åˆ°æ›´å°

```bash
ffmpeg -i <input> -vf "scale=1280:720:force_original_aspect_ratio=decrease" <output>
```

æ›´å¤šå…³äºç¼©æ”¾çš„æŠ€å·§ï¼š


- [http://trac.ffmpeg.org/wiki/Scaling%20(resizing)%20with%20ffmpeg](http://trac.ffmpeg.org/wiki/Scaling%20(resizing)%20with%20ffmpeg)
- [https://superuser.com/questions/547296/](https://superuser.com/questions/547296/)

### å¡«å……ï¼ˆPADDINGï¼‰

å¡«å……é»‘è¾¹åˆ°æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚å°† 1920 x 800 çš„è§†é¢‘å¡«å……åˆ° 1920 x 1080ï¼š

```bash
ffmpeg -i <input> -vf "pad=1920:1080:(ow-iw)/2:(oh-ih)/2" <output>
```

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-5.png)

ä½¿ç”¨å¤‡æ³¨ï¼š

- å¯ä»¥ä½¿ç”¨æ•°å­¦è¡¨è¾¾å¼
- ow å’Œ oh æ˜¯è¾“å‡ºæ–‡ä»¶çš„å®½å’Œé«˜
- iw å’Œ ih æ˜¯è¾“å…¥æ–‡ä»¶çš„å®½å’Œé«˜

### æ·¡å…¥æ·¡å‡ºï¼ˆFADINGï¼‰

åœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹ä½¿ç”¨æŒ‡å®šæŒç»­æ—¶é—´çš„ç®€å•æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼š

```bash
ffmpeg -i <input> -filter:v \
  "fade=t=in:st=0:d=5,fade=t=out:st=30:d=5" \
  <output>
```

è¯‘è€…æŒ‰ï¼šä½¿ç”¨ FFmpeg å‘½ä»¤è¡Œæ—¶ï¼Œæœ‰æ—¶ä¸€è¡Œä»£ç å¤ªé•¿ä¸æ–¹ä¾¿ç¼–å†™å’ŒæŸ¥çœ‹ï¼Œå°±å¯ä»¥ä½¿ç”¨æ¢è¡Œç¬¦åˆ†è¡Œç¼–å†™ï¼Œä¸åŒçš„ Shell æœ‰ä¸åŒçš„æ¢è¡Œç¬¦ï¼Œä¾‹å¦‚ â€œ\â€ æ˜¯ Bash çš„æ¢è¡Œç¬¦ï¼ŒWindows ä¸‹ CMD çš„æ¢è¡Œç¬¦æ˜¯ â€œ^â€ï¼Œè¯·æ³¨æ„æ›¿æ¢ã€‚

### æ–‡æœ¬ç»˜å›¾ / æ–‡å­—æ°´å°ï¼ˆDRAWING TEXTï¼‰

ç”¨äºåœ¨è§†é¢‘ä¸ŠåŠ ä¸Šæ–‡æœ¬çš„å¤æ‚ç³»ç»Ÿï¼š

```bash
ffmpeg -i <input> -vf \
drawtext="text='Test Text':x=100:y=50:\
fontsize=24:fontcolor=yellow:box=1:boxcolor=red" \
<output>
```

- å­—ä½“ã€å¤§å°ã€ä½ç½®ã€é¢œè‰²...éƒ½æœ‰éƒ½æœ‰å„ç§ç›¸å…³çš„å‚æ•°
- æ–‡å­—çƒ§å½•åŠŸèƒ½å¯ä»¥æ‹“å±•ï¼Œä¾‹å¦‚æŒ‰å¸§æ•°æˆ–è€…æ—¶é—´ç çƒ§å½•

æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚è€ƒï¼š[http://ffmpeg.org/ffmpeg-all.html#drawtext-1](http://ffmpeg.org/ffmpeg-all.html#drawtext-1)

## å¤æ‚è¿‡æ»¤å™¨ï¼ˆCOMPLEX FILTERINGï¼‰

å¤æ‚è¿‡æ»¤å™¨ä¸æ­¢ä¸€ä¸ªè¾“å…¥æˆ–è€…è¾“å‡ºï¼š

```bash
ffmpeg -i <input1> -i <input2> -filter_complex \
    "[0:v:0][1:v:0]overlay[outv]" \
    -map "[outv]" <output>
```

è¿‡ç¨‹æ‹†è§£ï¼š

- æŒ‡å®šè¾“å…¥åˆ°è¿‡æ»¤é“¾ï¼ˆfilterchainï¼‰ï¼ˆä¾‹å¦‚ [0:v:0][1:v:0]ï¼‰
- æŒ‡å®šè¿‡æ»¤é“¾ä¸­çš„æ»¤é•œï¼ˆä¾‹å¦‚ï¼šoverlayï¼‰
- æŒ‡å®šè¿‡æ»¤é“¾çš„è¾“å‡ºæ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼š[outv]ï¼‰
- æ˜ å°„è¾“å‡ºæ ‡ç­¾åˆ°è¾“å‡ºæ–‡ä»¶
- ä½¿ç”¨ ; ä¸€æ¬¡å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªè¿‡æ»¤é“¾

æ›´å¤šè¯¦ç»†å†…å®¹ï¼Œå‚è€ƒï¼š[http://ffmpeg.org/ffmpeg-all.html#Filtergraph-syntax-1](http://ffmpeg.org/ffmpeg-all.html#Filtergraph-syntax-1)

### æ‹¼æ¥è½¨é“ï¼ˆCONCATENATING STREAMSï¼‰

è§£ç ä¸‰ä¸ªè§†é¢‘/éŸ³é¢‘è½¨é“å¹¶æ‹¼æ¥åˆ°å¦ä¸€ä¸ªä¸­ï¼š

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-6.png)

```bash
ffmpeg -i <input1> -i <input2> -i <input3> -filter_complex \
    "[0:0][0:1][1:0][1:1][2:0][2:1]concat=n=3:v=1:a=1[outv][outa]" \
    -map "[outv]" -map "[outa]" <output>
```

æ›´å¤šä¿¡æ¯ï¼Œå‚è€ƒï¼š[http://trac.ffmpeg.org/wiki/Concatenate](http://trac.ffmpeg.org/wiki/Concatenate)ï¼ˆä¹Ÿé€‚ç”¨äºå…¶ä»–æ–¹æ³•ï¼‰

### æ—¶é—´çº¿ç¼–è¾‘ï¼ˆTIMELINE EDITINGï¼‰

ä»…åœ¨ç‰¹å®šæ—¶é—´ç‚¹å¯ç”¨è¿‡æ»¤å™¨

ä¾‹å¦‚ï¼š

- åœ¨å·¦ä¸Šè§’æ˜¾ç¤ºæ°´å°
- ä»…åœ¨ç¬¬ 1 å’Œç¬¬ 2 ç§’æ˜¾ç¤º

```bash
ffmpeg -i <video> -i <watermark> -filter_complex \
    "[0:v][1:v]overlay=10:10:enable='between(t,1,2)'[outv]" \
    -map "[outv]" <output>
```

æ›´å¤šç”¨æ³•ï¼Œè¯·å‚è€ƒï¼š[http://ffmpeg.org/ffmpeg-all.html#Timeline-editing](http://ffmpeg.org/ffmpeg-all.html#Timeline-editing)

## å…¶ä»–è¿‡æ»¤å™¨

é™¤äº†å‰é¢ä»‹ç»çš„é‚£äº›è¿‡æ»¤å™¨ï¼Œffmpeg ç”Ÿæ€ä¸­è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šå…¶ä»–çš„è¿‡æ»¤å™¨ã€‚

ä¾‹å¦‚ï¼š

- ä½¿ç”¨é€‰æ‹©è¿‡æ»¤å™¨æ£€æµ‹åœºæ™¯å˜åŒ–
- å»é™¤æ°´å°ï¼ˆdelogoï¼‰
- æ¨¡ç³Šã€è¾¹ç¼˜æ£€æµ‹å’Œå·ç§¯æ»¤æ³¢å™¨
- è§†é¢‘ç¨³å®š
- çŸ¢é‡ç¤ºæ³¢å™¨ã€ç›´æ–¹å›¾å’Œå…¶ä»–ä¿¡æ¯
- è‰²åº¦å’Œ alpha æ§åˆ¶
- å­—å¹•ç¼–è¾‘
- ...

## è®¡ç®—ç®€å•çš„è´¨é‡æŒ‡æ ‡

### PSNR (Peak Signal To Noise Ratio)

```bash
$ ffmpeg -i <degraded> -i <reference> -filter_complex psnr -f null /dev/null
[Parsed_psnr_0 @ 0x7fdb187045c0] PSNR y:33.437789 u:39.814416 v:39.319141 average:34.698320 min:29.305186 max:inf
```
è¯‘è€…æŒ‰ï¼šPSNR ä¸­æ–‡æ ‡å‡†è¯‘åä¸ºâ€œå³°å€¼ä¿¡å™ªæ¯”â€ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿçš„è¡¡é‡å‹ç¼©å½±åƒä¿¡å™ªæ¯”çš„æŒ‡æ ‡ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ [ä¸­æ–‡ç»´åŸºç™¾ç§‘ï¼šå³°å€¼ä¿¡å™ªæ¯”](https://zh.wikipedia.org/zh-cn/%E5%B3%B0%E5%80%BC%E4%BF%A1%E5%99%AA%E6%AF%94)

### SSIM ([Structural Similarity](https://en.wikipedia.org/wiki/SSIM))

```bash
$ ffmpeg -i <degraded> -i <reference> -filter_complex ssim -f null /dev/null
[Parsed_ssim_0 @ 0x7fbf0500b660] SSIM Y:0.925477 (11.277116) U:0.948906 (12.916325) V:0.946795 (12.740513) All:0.932935 (11.735054)
```

è¯‘è€…æŒ‰ï¼šSSIM ä¸­æ–‡ä¸€èˆ¬è¯‘ä¸ºâ€œç»“æ„ç›¸ä¼¼æ€§â€ï¼Œæ˜¯è¡¡é‡ä¸¤å¹…å›¾åƒç›¸ä¼¼åº¦çš„æŒ‡æ ‡ï¼Œå…¶è¯¦ç»†çš„ç§‘æ™®å’Œä½¿ç”¨å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š[ä½¿ç”¨SSIMé‡åŒ–è¯„ä»·è§†é¢‘ç¼–ç è´¨é‡](https://www.bilibili.com/read/cv7974104/)

è¯‘è€…æŒ‰ï¼šé™¤äº†åŸä½œè€…åˆ—å‡ºçš„ PSNR å’Œ SSIM ä¸¤ä¸ªæŒ‡æ ‡å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª Netflix å’Œ å—åŠ å·å¤§å­¦è”åˆå¼€å‘çš„ [VMAF](https://en.wikipedia.org/wiki/Video_Multimethod_Assessment_Fusion) ï¼ˆVideo Multimethod Assessment Fusionï¼‰æ˜¯ç›®å‰ Netflix ä¸»è¦ä½¿ç”¨çš„æŒ‡æ ‡ï¼Œè¯¦æƒ…è¿˜æ˜¯å¯ä»¥å‚è€ƒå‰æ–‡æåˆ°çš„è¿™ç¯‡æ–‡ç« ï¼š[ä»€ä¹ˆå†³å®šäº†ä½ çœ‹åˆ°çš„ç”»è´¨](https://sspai.com/post/66001)

# ä½¿ç”¨ ffprobe è·å–åª’ä½“ä¿¡æ¯

## åŸºæœ¬æ¦‚å¿µ

åŸºç¡€è¯­æ³•ï¼š

```bash
ffprobe <input>
    [-select_streams <selection>]
    [-show_streams|-show_format|-show_frames|-show_packets]
    [-show_entries <entries>]
    [-of <output-format>]
```

è§£é‡Šï¼š

- select_streams ç”¨äºæŒ‡å®šé€‰æ‹©è§†é¢‘æˆ–è€…éŸ³é¢‘
- show_ ç”¨äºé€‰æ‹©æ˜¾ç¤ºå“ªç§ç±»å‹çš„ä¿¡æ¯
- show_entries ç”¨äºé€‰æ‹©æ˜¾ç¤ºæ›´å°‘çš„ä¿¡æ¯
- of ç”¨äºè®¾ç½®è¾“å‡ºæ ¼å¼

æ›´å¤šä¿¡æ¯ï¼Œå‚è€ƒï¼š

- [https://ffmpeg.org/ffprobe.html](https://ffmpeg.org/ffprobe.html)
- [http://trac.ffmpeg.org/wiki/FFprobeTips](http://trac.ffmpeg.org/wiki/FFprobeTips)

## å®é™… ffpobe æ¡ˆä¾‹ Part 1

æ˜¾ç¤ºæ‰€æœ‰çš„æµï¼š

```bash
ffprobe <input> -show_streams
```

æ˜¾ç¤ºè§†é¢‘æµä¿¡æ¯ï¼š

```bash
ffprobe <input> -select_streams v -show_format
```

Show presentation timestamp and frame type of every frame, in CSV format (p=0 disables CSV section headers):

```bash
ffprobe <input> -select_streams v -show_frames \
-show_entries frame=pkt_pts_time,pict_type -of csv=p=0
```

è¯‘è€…æŒ‰ï¼šç¬¬ä¸‰ä¸ªæ¡ˆä¾‹ä¸å¤ªæ‡‚ï¼Œæˆ‘è‡ªå·±è¯•äº†è¯•ï¼Œæ•ˆæœä¹Ÿæœ‰ç‚¹å¥‡æ€ªï¼Œå…ˆæ”¾ç€å§ ğŸ˜‚

## å®é™… ffpobe æ¡ˆä¾‹ Part 2

æ›´æ”¹è¾“å‡ºä¸º JSON æ ¼å¼ï¼š

```bash
ffprobe <input> -select_streams v -show_packets -of json
```

è·å–æ–‡ä»¶ä¸­æµçš„ç¼–å·ï¼ˆnk = 1 ç¦ç”¨ keysï¼‰

```bash
ffprobe <input> -show_format -show_entries format=nb_streams -of compact=nk=1:p=0
```

ä»¥ç§’æˆ– HH:MM:SS.ms ä¸ºå•ä½è·å–è§†é¢‘é•¿åº¦

```bash
ffprobe <input> -show_format -show_entries format=duration -of compact=nk=1:p=0
ffprobe -sexagesimal <input> -show_format -show_entries format=duration -of compact=nk=1:p=0
```

ä»¥ Bit/s ä¸ºå•ä½è·å–éŸ³é¢‘æµ

```bash
ffprobe <input> -select_streams a -show_entries stream=bit_rate -of compact=nk=1:p=0
```

è¯‘è€…æŒ‰ï¼šå…¶å®è¿™ä¸€ç« èŠ‚çš„æ¡ˆä¾‹æˆ‘ä¸ªäººè§‰å¾—æ²¡æœ‰å¾ˆå¤§ä½œç”¨ï¼Œå¹³æ—¶æŸ¥çœ‹åª’ä½“æ–‡ä»¶çš„ä¿¡æ¯åŸºæœ¬ä¸Šä½¿ç”¨ `ffprobe <input> -hide_banner` å°±å¤Ÿäº†ã€‚

# æ£€æŸ¥è§†é¢‘ç¼–è§£ç å™¨

## è°ƒè¯•è¿åŠ¨å‘é‡

åœ¨ FFmpeg ä¸­ä½¿ç”¨ H.264 ç¼–è§£ç å™¨å¯è§†åŒ–è¿åŠ¨å‘é‡çš„ç®€å•æ–¹æ³•ï¼ˆä¸é€‚ç”¨äºå…¶ä»–ç¼–è§£ç å™¨ï¼‰

```bash
ffplay -flags2 +export_mvs input.mp4 -vf codecview=mv=pf+bf+bb
ffmpeg -flags2 +export_mvs -i input.mp4 -vf codecview=mv=pf+bf+bb <output>
```

- pf â€“ P å¸§çš„å‘å‰é¢„æµ‹è¿åŠ¨å‘é‡
- bf â€“ B å¸§çš„å‘å‰é¢„æµ‹è¿åŠ¨å‘é‡
- bb â€“ B å¸§çš„å‘åé¢„æµ‹è¿åŠ¨å‘é‡

![image](https://img.lifelog.cool/FFmpeg-Encoding-and-Editing-Course-7.png)

è·Ÿå¤šå‚è€ƒï¼š[http://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors](http://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors)

è¯‘è€…æŒ‰ï¼šè¿åŠ¨å‘é‡è¿™æ–¹é¢çš„çŸ¥è¯†ç‚¹æˆ‘ä¹Ÿä¸æ‡‚ï¼Œæ¥æ—¥å†è¡¥å……å§ ğŸ˜‚

## è§†é¢‘æµåˆ†æ

å›¾å½¢åŒ–æ–¹å¼åˆ†æè§†é¢‘æµçš„å…¶ä»–è½¯ä»¶ï¼š

- [Elecard Stream Analyzer](https://www.elecard.com/products/video-analysis/stream-analyzer) (å•†ä¸š)
- [CodecVisa](http://www.codecian.com/) (å•†ä¸š)
- [Intel Video Pro Analyzer](https://software.intel.com/en-us/intel-video-pro-analyzer) (å•†ä¸š)
- [AOMAnalyzer](https://people.xiph.org/~mbebenita/analyzer/) (å…è´¹ï¼Œé’ˆå¯¹ AV1/VP9 ç¼–ç çš„è§†é¢‘)

# æ€»ç»“

é€šè¿‡è¿™èŠ‚è¯¾ç¨‹ï¼Œä½ åº”è¯¥å­¦åˆ°äº†ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š

- ç†è§£ FFmpeg åº“ï¼Œç¼–è§£ç å™¨ï¼Œå®¹å™¨ï¼Œç¼–ç å™¨...
- ç¼–ç è§†é¢‘å’ŒéŸ³é¢‘
- ä½¿ç”¨åŸºç¡€çš„è¿‡æ»¤å™¨
- è¯»å–æµä¿¡æ¯å’Œå…ƒæ•°æ®
- å¦‚æœä½ é‡åˆ°äº†å›°éš¾ï¼Œä¼šå¯»æ‰¾å¸®åŠ©